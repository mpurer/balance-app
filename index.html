<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GyroGame">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="GyroGame">
<meta name="theme-color" content="#000000">
<title>Gyro Dot Target Game</title>
<style>
html, body { margin:0; padding:0; height:100%; width:100%; display:flex; justify-content:center; align-items:center; background:#f7f7f9; font-family:sans-serif; }
#arena { position:relative; width:100%; height:100%; background:#eee; overflow:hidden; }
#dot { position:absolute; width:36px; height:36px; border-radius:50%; background:#0575e6; transform:translate(-50%,-50%); }
#btn, #calibrateBtn { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); padding:12px 18px; font-size:16px; z-index:10; }
#scoreDisplay, #timerDisplay { position:absolute; font-size:20px; font-weight:600; color:#111; background:rgba(255,255,255,0.7); padding:6px 12px; border-radius:8px; }
#scoreDisplay { top: calc(env(safe-area-inset-top) + 36px); left:16px; }
#timerDisplay { top: calc(env(safe-area-inset-top) + 36px); right:16px; }
canvas { position:absolute; left:0; top:0; }
/* Game over overlay */
#gameOverOverlay { display:none; position:absolute; inset:0; background:#ffffff; z-index:50; display:flex; justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
#gameOverCard { width:100%; max-width:640px; text-align:center; }
#finalScoreBig { font-size:48px; font-weight:800; color:#111; margin-bottom:8px; }
#overlayButtons { display:flex; justify-content:center; gap:12px; margin-top:12px; }
.btnPrimary { background:#0575e6; color:white; border:none; padding:10px 14px; border-radius:10px; font-weight:700; }
.btnSecondary { background:#f0f0f0; color:#111; border:none; padding:10px 14px; border-radius:10px; font-weight:700; }
#saveNameRow { margin-top:12px; display:none; justify-content:center; gap:8px; }
#nameInput { padding:8px 10px; border-radius:8px; border:1px solid #ddd; min-width:180px; }
#leaderboard { margin-top:16px; text-align:left; max-height:260px; overflow:auto; border-radius:8px; background:rgba(0,0,0,0.02); padding:8px; }
#leaderboard ol { margin:0; padding:0 12px; }
#leaderboard li { padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.03); display:flex; justify-content:space-between; font-weight:600; }
.smallNote { font-size:13px; color:#666; margin-top:8px; }
</style>
</head>
<body>

<div id="arena">
  <canvas id="targetCanvas"></canvas>
  <div id="dot"></div>
  <div id="scoreDisplay">Score: 0</div>
  <div id="timerDisplay">30</div>
  <button id="btn">Enable Gyro</button>
  <button id="calibrateBtn" style="display:none;">Calibrate Neutral</button>

  <div id="gameOverOverlay" aria-hidden="true">
    <div id="gameOverCard">
      <div id="finalScoreBig">Score: 0</div>
      <div id="overlayButtons">
        <button id="retryBtn" class="btnPrimary">Retry</button>
        <button id="saveBtn" class="btnSecondary">Save score</button>
      </div>
      <div id="saveNameRow">
        <input id="nameInput" placeholder="Your name" />
        <button id="confirmSave" class="btnPrimary">Save</button>
      </div>
      <div id="leaderboard" aria-live="polite">
        <div style="font-weight:800; margin-bottom:8px;">Leaderboard</div>
        <ol id="lbList"></ol>
      </div>
      <div class="smallNote">Scores saved locally on this device. Clearing browser data will remove them.</div>
    </div>
  </div>
</div>

<script>
/* Config */
const LB_KEY = 'tilt_dot_leaderboard_v6';
const GAME_DURATION = 30;
const DOT_RADIUS = 18;
const MAX_TILT = 30; // degrees that maps to full arena
const ringRadii = [30, 60, 90];
const maxPointsPerSecond = 10;

const dot = document.getElementById('dot');
const btn = document.getElementById('btn');
const calibrateBtn = document.getElementById('calibrateBtn');
const arena = document.getElementById('arena');
const scoreDisplay = document.getElementById('scoreDisplay');
const timerDisplay = document.getElementById('timerDisplay');
const canvas = document.getElementById('targetCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('gameOverOverlay');
const finalScoreBig = document.getElementById('finalScoreBig');
const retryBtn = document.getElementById('retryBtn');
const saveBtn = document.getElementById('saveBtn');
const saveNameRow = document.getElementById('saveNameRow');
const nameInput = document.getElementById('nameInput');
const confirmSave = document.getElementById('confirmSave');
const lbList = document.getElementById('lbList');

/* State */
let arenaRect = arena.getBoundingClientRect();
canvas.width = arenaRect.width;
canvas.height = arenaRect.height;

let dotPos = { x: arenaRect.width/2, y: arenaRect.height/2 };
let dotPos0 = { x: dotPos.x, y: dotPos.y };
let targetCenter = { x: arenaRect.width/2, y: arenaRect.height/2 };
const maxDistance = ringRadii[ringRadii.length-1];

let score = 0;
let lastTime = 0;
let timeLeft = GAME_DURATION;
let gameActive = false;

let beta0 = 0, gamma0 = 0;
const isiPad = /iPad/.test(navigator.userAgent);

/* Leaderboard */
function loadLeaderboard(){ const list=JSON.parse(localStorage.getItem(LB_KEY)||'[]'); return list.sort((a,b)=>b.score-b.score || a.date-b.date); }
function saveLocalScore(name, scoreValue){ const list=loadLeaderboard(); list.push({name:(name||'Player'), score:Math.floor(scoreValue), date:Date.now()}); list.sort((a,b)=>b.score-b.score || a.date-b.date); localStorage.setItem(LB_KEY, JSON.stringify(list.slice(0,50))); }
function renderLeaderboard(){ const list=loadLeaderboard(); lbList.innerHTML=''; if(list.length===0){ const li=document.createElement('li'); li.textContent='No scores yet â€” be the first!'; lbList.appendChild(li); return; } let place=1; for(const e of list.slice(0,20)){ const li=document.createElement('li'); li.innerHTML=`<span>#${place} ${escapeHtml(e.name)}</span><span>${e.score}</span>`; lbList.appendChild(li); place++; } }
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* Draw target */
function drawTargetAndRings(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.lineWidth=2; ringRadii.forEach(r=>{ ctx.beginPath(); ctx.arc(targetCenter.x,targetCenter.y,r,0,Math.PI*2); ctx.stroke(); }); ctx.fillStyle='#ff5c5c'; ctx.beginPath(); ctx.arc(targetCenter.x,targetCenter.y,6,0,Math.PI*2); ctx.fill(); }

/* Update loop */
function clamp(val,min,max){ return Math.min(Math.max(val,min),max); }
function update(){ const now=performance.now(); const deltaTime=(lastTime?(now-lastTime)/1000:0); lastTime=now; if(gameActive){ drawTargetAndRings(); const dx=dotPos.x-targetCenter.x; const dy=dotPos.y-targetCenter.y; const distance=Math.hypot(dx,dy); if(distance<=maxDistance) score += maxPointsPerSecond*(1-distance/maxDistance)*deltaTime; scoreDisplay.textContent='Score: '+Math.floor(score); timeLeft -= deltaTime; if(timeLeft<=0){ timeLeft=0; endGame(); } timerDisplay.textContent=Math.ceil(timeLeft); } requestAnimationFrame(update); }
update();

/* Gyro handler */
function handleOrientation(e){
  if(!gameActive) return;
  let beta = (e.beta||0) - beta0;
  let gamma = (e.gamma||0) - gamma0;
  const angle = screen.orientation?.angle || window.orientation || 0;
  let dx=0, dy=0;
  switch(angle){ case 0: dx=gamma; dy=beta; break; case 90: dx=beta; dy=-gamma; break; case -90: dx=-beta; dy=gamma; break; case 180: dx=-gamma; dy=-beta; break; default: dx=gamma; dy=beta; }
  if(isiPad && angle===0) [dx,dy]=[dy,-dx];
  dotPos.x = clamp(dotPos0.x + (dx/MAX_TILT)*arenaRect.width, DOT_RADIUS, arenaRect.width-DOT_RADIUS);
  dotPos.y = clamp(dotPos0.y + (dy/MAX_TILT)*arenaRect.height, DOT_RADIUS, arenaRect.height-DOT_RADIUS);
  dot.style.left=dotPos.x+'px'; dot.style.top=dotPos.y+'px';
}

/* Enable gyro */
async function enableGyro(){ if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){ try{ const res=await DeviceOrientationEvent.requestPermission(); if(res==='granted'){ btn.style.display='none'; calibrateBtn.style.display='block'; window.addEventListener('deviceorientation',handleOrientation); } else alert('Permission denied'); }catch(err){ alert('Error requesting permission'); } } else { btn.style.display='none'; calibrateBtn.style.display='block'; window.addEventListener('deviceorientation',handleOrientation); } }
btn.addEventListener('click',enableGyro);

/* Calibrate */
calibrateBtn.addEventListener('click', e=>{
  beta0=0; gamma0=0;
  dotPos0={x:dotPos.x, y:dotPos.y};
  calibrateBtn.style.display='none';
  lastTime=performance.now(); timeLeft=GAME_DURATION; score=0;
  gameActive=true;
});

/* End game */
function endGame(){ gameActive=false; finalScoreBig.textContent='Score: '+Math.floor(score); overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); renderLeaderboard(); }

/* Retry */
retryBtn.addEventListener('click',()=>{
  overlay.style.display='none'; overlay.setAttribute('aria-hidden','true');
  dot.style.display='block'; btn.style.display='block';
  arenaRect=arena.getBoundingClientRect(); canvas.width=arenaRect.width; canvas.height=arenaRect.height;
  targetCenter={x:arenaRect.width/2,y:arenaRect.height/2};
  dotPos={x:arenaRect.width/2,y:arenaRect.height/2};
  dotPos0={x:dotPos.x,y:dotPos.y};
  score=0; timeLeft=GAME_DURATION; scoreDisplay.textContent='Score:0'; timerDisplay.textContent=GAME_DURATION;
  saveNameRow.style.display='none'; nameInput.value='';
});

/* Save score */
saveBtn.addEventListener('click',()=>{ saveNameRow.style.display='flex'; nameInput.focus(); });
confirmSave.addEventListener('click',()=>{
  const name=(nameInput.value||'Player').trim();
  if(name.length===0){ alert('Please enter a name'); nameInput.focus(); return; }
  saveLocalScore(name,score); saveNameRow.style.display='none'; nameInput.value=''; renderLeaderboard(); alert('Score saved!');
});
nameInput.addEventListener('keyup', e=>{ if(e.key==='Enter') confirmSave.click(); });

/* Resize */
window.addEventListener('resize', ()=>{
  arenaRect=arena.getBoundingClientRect(); canvas.width=arenaRect.width; canvas.height=arenaRect.height;
  targetCenter={x:arenaRect.width/2,y:arenaRect.height/2};
});

/* Init */
(function init(){ dot.style.left=dotPos.x+'px'; dot.style.top=dotPos.y+'px'; overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); calibrateBtn.style.display='none'; })();
</script>
</body>
</html>
