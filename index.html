<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tilt Dot — Gyro MVP</title>
<style>
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#111}
  .wrap{display:flex;flex-direction:column;height:100vh;padding:12px;box-sizing:border-box;gap:10px}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between}
  #arena{flex:1;background:#f7f7f9;border-radius:12px;position:relative;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  #dot{position:absolute;width:36px;height:36px;border-radius:50%;background:#0575e6;left:50%;top:50%;transform:translate(-50%,-50%);box-shadow:0 6px 12px rgba(5,117,230,0.25)}
  #target{position:absolute;width:28px;height:28px;border-radius:50%;background:#ff5c5c;box-shadow:0 6px 10px rgba(255,92,92,0.2)}
  .controls{display:flex;gap:8px;align-items:center}
  .big{font-size:18px;font-weight:600}
  input[type="text"]{padding:6px 8px;border-radius:8px;border:1px solid #ddd}
  button{padding:8px 12px;border-radius:8px;border:0;background:#111;color:#fff}
  .small{font-size:13px;color:#555}
  #leaderboard{max-width:320px}
  #messages{color:#c33}
  footer{display:flex;gap:10px;align-items:center;justify-content:space-between}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="big">Tilt Dot — Gyro MVP</div>
      <div class="small">Tilt your phone to move the blue dot. Collect red targets.</div>
    </div>
    <div id="scoreUI" class="controls">
      <div>Score: <span id="score">0</span></div>
      <button id="resetScores">Reset Scores</button>
    </div>
  </header>

  <div id="arena">
    <div id="dot"></div>
    <div id="target"></div>
  </div>

  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="nameInput" type="text" placeholder="Your name" />
      <button id="saveScore">Save Score</button>
    </div>

    <div id="messages" class="small"></div>

    <div id="leaderboard" style="margin-left:auto">
      <div class="small">Leaderboard (local)</div>
      <ol id="lbList"></ol>
    </div>
  </div>

  <footer>
    <div class="small">Tips: On iOS you may need to allow Motion & Orientation access.</div>
    <div class="small">Controls fallback: drag the screen if sensors aren't available.</div>
  </footer>
</div>

<script>
/* Basic constants */
const arena = document.getElementById('arena');
const dotEl = document.getElementById('dot');
const targetEl = document.getElementById('target');
const scoreEl = document.getElementById('score');
const saveBtn = document.getElementById('saveScore');
const nameInput = document.getElementById('nameInput');
const lbList = document.getElementById('lbList');
const messages = document.getElementById('messages');
const resetBtn = document.getElementById('resetScores');

let arenaRect;
let dot = { x: 0, y: 0, r: 18 };
let target = { x: 100, y: 100, r: 14 };
let score = 0;

/* Sensor smoothing and sensitivity */
let vel = { x: 0, y: 0 };
const smooth = 0.12;      // smoothing factor (0-1) lower = smoother
let sensitivity = 0.8;    // higher = faster movement

/* Setup after layout */
function setup() {
  arenaRect = arena.getBoundingClientRect();
  dot.x = arenaRect.width / 2;
  dot.y = arenaRect.height / 2;
  placeTargetRandom();
  updatePositions();
  loadLeaderboard();
}
window.addEventListener('resize', setup);
window.addEventListener('orientationchange', setup);
setup();

/* Position update loop (animation) */
function updatePositions() {
  // clamp inside arena
  dot.x = Math.max(dot.r, Math.min(arenaRect.width - dot.r, dot.x));
  dot.y = Math.max(dot.r, Math.min(arenaRect.height - dot.r, dot.y));
  dotEl.style.left = dot.x + 'px';
  dotEl.style.top = dot.y + 'px';
  targetEl.style.left = (target.x - target.r) + 'px';
  targetEl.style.top = (target.y - target.r) + 'px';

  // collision check
  const dx = dot.x - target.x;
  const dy = dot.y - target.y;
  const dist = Math.hypot(dx, dy);
  if (dist < dot.r + target.r) {
    score += 1;
    scoreEl.textContent = score;
    placeTargetRandom();
  }

  requestAnimationFrame(updatePositions);
}

/* Randomly place a target away from the dot */
function placeTargetRandom() {
  const margin = 40;
  target.x = Math.random() * (arenaRect.width - 2*margin) + margin;
  target.y = Math.random() * (arenaRect.height - 2*margin) + margin;
}

/* Device orientation handler (tilt) */
function handleOrientation(event) {
  // prefer gamma (left-right) and beta (front-back)
  let gamma = event.gamma ?? 0; // left/right tilt [-90..90]
  let beta  = event.beta  ?? 0; // front/back tilt [-180..180]

  // convert tilt to velocity
  // gamma => x-axis (tilt right moves dot right)
  // beta  => y-axis (tilt forward moves dot down)
  // Normalize and scale
  let targetVelX = (gamma / 90) * sensitivity * 20;
  let targetVelY = (beta  / 90) * sensitivity * 20;

  // smoothing (simple lerp)
  vel.x += (targetVelX - vel.x) * smooth;
  vel.y += (targetVelY - vel.y) * smooth;

  // update position
  dot.x += vel.x;
  dot.y += vel.y;
}

/* Fallback: pointer drag to move dot (desktop) */
let dragging = false;
arena.addEventListener('pointerdown', (e) => {
  dragging = true;
  vel.x = vel.y = 0;
});
window.addEventListener('pointerup', () => dragging = false);
arena.addEventListener('pointermove', (e) => {
  if (!dragging) return;
  const rect = arena.getBoundingClientRect();
  dot.x = e.clientX - rect.left;
  dot.y = e.clientY - rect.top;
});

/* Permission request for iOS (DeviceMotion/DeviceOrientation) */
async function enableMotionIfNeeded() {
  messages.textContent = '';
  // iOS 13+ requires permission via requestPermission
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    try {
      const res = await DeviceMotionEvent.requestPermission();
      if (res === 'granted') {
        window.addEventListener('deviceorientation', handleOrientation);
        messages.textContent = 'Gyro access granted. Tilt device!';
      } else {
        messages.textContent = 'Gyro permission denied. Use touch to test.';
      }
    } catch (err) {
      messages.textContent = 'Permission request failed: ' + err;
    }
  } else {
    // non-iOS or older: just attach listener
    window.addEventListener('deviceorientation', handleOrientation);
    messages.textContent = 'Gyro listener attached. If sensor not available, try touch drag.';
  }
}

/* Some browsers use devicemotion.rotationRate instead - try both */
function tryDevMotionFallback() {
  window.addEventListener('devicemotion', (ev) => {
    // rotationRate has alpha/beta/gamma in degrees per second
    const r = ev.rotationRate;
    if (r) {
      // tiny integration to emulate orientation - keep simple
      handleOrientation({ gamma: (r.gamma || 0) * 0.02, beta: (r.beta || 0) * 0.02 });
    }
  });
}

/* Start sensors on first user gesture (some browsers require that) */
function requestStartOnTap() {
  const startBtn = document.createElement('button');
  startBtn.textContent = 'Enable Motion (tap)';
  startBtn.style.position = 'absolute';
  startBtn.style.left = '50%';
  startBtn.style.top = '50%';
  startBtn.style.transform = 'translate(-50%,-50%)';
  startBtn.style.padding = '10px 14px';
  startBtn.style.borderRadius = '10px';
  startBtn.style.background = '#111';
  startBtn.style.color = '#fff';
  startBtn.style.zIndex = 9999;
  arena.appendChild(startBtn);

  startBtn.addEventListener('click', async () => {
    arena.removeChild(startBtn);
    await enableMotionIfNeeded();
    tryDevMotionFallback();
  });
}
requestStartOnTap();

/* Leaderboard (localStorage) */
const LB_KEY = 'tilt_dot_leaderboard_v1';

function saveScoreLocal() {
  const name = (nameInput.value || 'Player').trim();
  const entry = { name, score, date: Date.now() };
  const list = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
  list.push(entry);
  // keep only top 20 sorted by score desc
  list.sort((a,b) => b.score - a.score || a.date - b.date);
  localStorage.setItem(LB_KEY, JSON.stringify(list.slice(0,20)));
  loadLeaderboard();
  messages.textContent = 'Score saved locally!';
}

function loadLeaderboard() {
  const list = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
  lbList.innerHTML = '';
  for (const e of list) {
    const li = document.createElement('li');
    li.textContent = `${e.name} — ${e.score}`;
    lbList.appendChild(li);
  }
}

/* Reset local leaderboard */
resetBtn.addEventListener('click', () => {
  if (!confirm('Reset local leaderboard?')) return;
  localStorage.removeItem(LB_KEY);
  loadLeaderboard();
});

/* Save button */
saveBtn.addEventListener('click', saveScoreLocal);

/* Allow pressing Enter in name input to save */
nameInput.addEventListener('keyup', (e) => {
  if (e.key === 'Enter') saveScoreLocal();
});
</script>
</body>
</html>
