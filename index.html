<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no, viewport-fit=cover" />
<title>Gyro Dot Target Game</title>

<!-- Force PWA landscape mode -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="apple-mobile-web-app-orientation" content="landscape" />

<style>
html, body {
  margin:0; padding:0; height:100%; width:100%; overflow:hidden;
  font-family:system-ui, sans-serif;
  background:#f7f7f9;
  display:flex; justify-content:center; align-items:center;
}
#arena {
  position:relative; width:100%; height:100%; overflow:hidden;
  background:#eee;
}
#dot {
  position:absolute; width:36px; height:36px; border-radius:50%;
  background:#0575e6; transform:translate(-50%, -50%);
}
#btn, #calibrateBtn {
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  padding:12px 18px; font-size:18px; z-index:10;
  background:#0575e6; color:#fff; border:none; border-radius:12px;
  font-weight:600;
}
#calibrateBtn { display:none; }

#scoreDisplay, #timerDisplay {
  position:absolute; font-size:20px; font-weight:600;
  background:rgba(255,255,255,0.7);
  padding:6px 12px; border-radius:8px;
}
#scoreDisplay { left:16px; top:16px; }
#timerDisplay { right:16px; top:16px; }

#gameOverOverlay {
  display:none; position:absolute; inset:0;
  background:white; z-index:50;
  display:flex; justify-content:center; align-items:center;
}
#gameOverCard { width:90%; max-width:640px; text-align:center; }
#finalScoreBig { font-size:48px; font-weight:800; margin-bottom:16px; }

/* Buttons */
.btnPrimary {
  background:#0575e6; color:white; border:none;
  padding:10px 14px; border-radius:10px; font-weight:700;
}
.btnSecondary {
  background:#f0f0f0; color:#111; border:none;
  padding:10px 14px; border-radius:10px; font-weight:700;
}
#overlayButtons { display:flex; gap:12px; justify-content:center; margin-bottom:16px; }

#saveNameRow { display:none; gap:8px; justify-content:center; margin-bottom:20px; }
#nameInput {
  padding:8px 10px; border-radius:8px;
  border:1px solid #ddd; min-width:180px;
}
.smallNote { color:#666; font-size:13px; margin-top:12px; }

/* Modern Table Leaderboard */
#leaderboardContainer {
  margin-top:20px; width:100%; overflow:hidden;
  background:#fafafa; border-radius:12px;
  border:1px solid #e5e5e5;
}
#leaderboardTable { width:100%; border-collapse:collapse; }
#leaderboardTable thead tr {
  background:#0575e6; color:white; text-align:left;
}
#leaderboardTable th, #leaderboardTable td {
  padding:12px 14px; font-size:16px;
}
#leaderboardTable tbody tr:nth-child(even) {
  background:#f0f6ff;
}
#leaderboardTable tbody tr:nth-child(odd) {
  background:white;
}
#leaderboardTable td:last-child,
#leaderboardTable th:last-child {
  text-align:right;
}
</style>
</head>
<body>
<div id="arena">
  <canvas id="targetCanvas"></canvas>
  <div id="dot"></div>

  <div id="scoreDisplay">Score: 0</div>
  <div id="timerDisplay">30</div>

  <button id="btn">Enable Gyro</button>
  <button id="calibrateBtn">Calibrate Neutral</button>

  <!-- Game Over Screen -->
  <div id="gameOverOverlay" aria-hidden="true">
    <div id="gameOverCard">
      <div id="finalScoreBig">Score: 0</div>

      <div id="overlayButtons">
        <button id="retryBtn" class="btnPrimary">Retry</button>
        <button id="saveBtn" class="btnSecondary">Save Score</button>
      </div>

      <div id="saveNameRow">
        <input id="nameInput" placeholder="Your name" />
        <button id="confirmSave" class="btnPrimary">Save</button>
      </div>

      <!-- Leaderboard -->
      <div id="leaderboardContainer">
        <table id="leaderboardTable">
          <thead>
            <tr>
              <th>Ranking</th>
              <th>Name</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>

      <div class="smallNote">Scores stored locally in your browser</div>
    </div>
  </div>
</div>

<script>
/* — CONFIG — */
const LB_KEY = 'tilt_dot_leaderboard_v11';
const GAME_DURATION = 30;
const DOT_RADIUS = 18;
const MAX_TILT = 30;
const ringRadii = [30, 60, 90];
const maxPointsPerSecond = 10;

/* — ELEMENTS — */
const arena = document.getElementById('arena');
const dot = document.getElementById('dot');
const scoreDisplay = document.getElementById('scoreDisplay');
const timerDisplay = document.getElementById('timerDisplay');
const canvas = document.getElementById('targetCanvas');
const ctx = canvas.getContext('2d');
const btn = document.getElementById('btn');
const calibrateBtn = document.getElementById('calibrateBtn');
const overlay = document.getElementById('gameOverOverlay');
const finalScoreBig = document.getElementById('finalScoreBig');
const retryBtn = document.getElementById('retryBtn');
const saveBtn = document.getElementById('saveBtn');
const saveNameRow = document.getElementById('saveNameRow');
const confirmSave = document.getElementById('confirmSave');
const nameInput = document.getElementById('nameInput');
const leaderboardBody = document.getElementById('leaderboardBody');

/* — STATE — */
let arenaRect = arena.getBoundingClientRect();
canvas.width = arenaRect.width;
canvas.height = arenaRect.height;

let targetCenter = { x: arenaRect.width/2, y: arenaRect.height/2 };
let dotPos = { x: targetCenter.x, y: targetCenter.y };
let dotPos0 = { ...dotPos };

let beta0 = 0, gamma0 = 0;
let score = 0;
let lastTime = 0;
let timeLeft = GAME_DURATION;
let gameActive = false;

/* — LEADERBOARD — */
function loadLeaderboard() {
  return JSON.parse(localStorage.getItem(LB_KEY) || '[]')
    .sort((a,b)=>b.score-a.score).
    slice(0,50);
}
function saveLocalScore(name, score) {
  const list = loadLeaderboard();
  list.push({ name, score: Math.floor(score), date: Date.now() });
  list.sort((a,b)=>b.score-a.score);
  localStorage.setItem(LB_KEY, JSON.stringify(list.slice(0,50)));
}
function renderLeaderboard() {
  const list = loadLeaderboard();
  leaderboardBody.innerHTML = '';

  if(list.length === 0) {
    leaderboardBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:20px;">No scores yet</td></tr>`;
    return;
  }

  list.forEach((entry, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>#${i+1}</td>
      <td>${escapeHtml(entry.name)}</td>
      <td>${entry.score}</td>
    `;
    leaderboardBody.appendChild(tr);
  });
}
function escapeHtml(txt) {
  return String(txt).replace(/[&<>"']/g, s => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[s]));
}

/* — DRAW TARGET — */
function drawTarget() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = 'rgba(0,0,0,0.2)';
  ctx.lineWidth = 2;
  ringRadii.forEach(r => {
    ctx.beginPath();
    ctx.arc(targetCenter.x,targetCenter.y,r,0,Math.PI*2);
    ctx.stroke();
  });
  ctx.fillStyle = '#ff5c5c';
  ctx.beginPath();
  ctx.arc(targetCenter.x,targetCenter.y,6,0,Math.PI*2);
  ctx.fill();
}

drawTarget();

targetCenter = { x: arenaRect.width/2, y: arenaRect.height/2 };
function update() {
  const now = performance.now();
  const dt = lastTime ? (now-lastTime)/1000 : 0;
  lastTime = now;

  if(gameActive) {
    drawTarget();

    const dx = dotPos.x - targetCenter.x;
    const dy = dotPos.y - targetCenter.y;
    const dist = Math.hypot(dx,dy);

    if(dist <= ringRadii[ringRadii.length-1]) {
      score += maxPointsPerSecond * (1 - dist/ringRadii[ringRadii.length-1]) * dt;
    }
    scoreDisplay.textContent = "Score: " + Math.floor(score);

    timeLeft -= dt;
    if(timeLeft <= 0) {
      timeLeft = 0;
      endGame();
    }
    timerDisplay.textContent = Math.ceil(timeLeft);
  }

  requestAnimationFrame(update);
}
update();

/* — GYRO — */
function handleOrientation(e) {
  if(!gameActive) return;

  const beta = (e.beta||0) - beta0;
  const gamma = (e.gamma||0) - gamma0;

  let angle = screen.orientation?.angle || window.orientation || 0;

  let dx = 0, dy = 0;
  switch(angle) {
    case 90: dx = beta; dy = -gamma; break;
    case -90: case 270: dx = -beta; dy = gamma; break;
    default: dx = gamma; dy = beta;
  }

  const scaleX = arenaRect.width / MAX_TILT;
  const scaleY = arenaRect.height / MAX_TILT;

  dotPos.x = Math.max(DOT_RADIUS, Math.min(arenaRect.width-DOT_RADIUS, dotPos0.x + dx * scaleX));
  dotPos.y = Math.max(DOT_RADIUS, Math.min(arenaRect.height-DOT_RADIUS, dotPos0.y + dy * scaleY));

  dot.style.left = dotPos.x + 'px';
  dot.style.top = dotPos.y + 'px';
}

window.addEventListener('deviceorientation', e => {
  window.lastBeta = e.beta;
  window.lastGamma = e.gamma;
});

/* — ENABLE GYRO — */
btn.addEventListener('click', async () => {
  if(typeof DeviceOrientationEvent !== 'undefined' && DeviceOrientationEvent.requestPermission) {
    const res = await DeviceOrientationEvent.requestPermission();
    if(res !== 'granted') { alert("Permission required"); return; }
  }
  window.addEventListener('deviceorientation', handleOrientation);
  btn.style.display = 'none';
  calibrateBtn.style.display = 'block';
});

/* — CALIBRATE — */
calibrateBtn.addEventListener('click', () => {
  beta0 = window.lastBeta || 0;
  gamma0 = window.lastGamma || 0;

  dotPos0 = { x: targetCenter.x, y: targetCenter.y };
  dotPos = { ...dotPos0 };
  dot.style.left = dotPos.x + 'px';
  dot.style.top = dotPos.y + 'px';

  calibrateBtn.style.display = 'none';
  score = 0;
  timeLeft = GAME_DURATION;
  lastTime = performance.now();
  gameActive = true;
});

/* — END GAME — */
function endGame() {
  gameActive = false;
  finalScoreBig.textContent = "Score: " + Math.floor(score);
  overlay.style.display = 'flex';
  renderLeaderboard();
}

/* — RETRY — */
retryBtn.addEventListener('click', () => {
  overlay.style.display = 'none';
  btn.style.display = 'block';
  saveNameRow.style.display = 'none';
  nameInput.value = '';
});

/* — SAVE SCORE — */
saveBtn.addEventListener('click', () => {
  saveNameRow.style.display = 'flex';
  nameInput.focus();
});

confirmSave.addEventListener('click', () => {
  const name = nameInput.value.trim() || 'Player';
  saveLocalScore(name, score);
  saveNameRow.style.display = 'none';
  nameInput.value = '';
  renderLeaderboard();
});
</script>

</body>
</html>