<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no, viewport-fit=cover" />
<title>Firebase Live Leaderboard</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script>
  // Your Firebase project configuration for "gibbon-balance-game"
  const firebaseConfig = {
    apiKey: "AIzaSyA7BZvLHuIXiYdukRpV7bM52pBBuWzv3rU", // <--- PASTE YOUR API KEY HERE
    authDomain: "gibbon-balance-game.firebaseapp.com",
    projectId: "gibbon-balance-game",
    storageBucket: "gibbon-balance-game.firebasestorage.app",
    messagingSenderId: "435375118778",
    appId: "1:435375118778:web:5513fc213d8d7fef816583" // <--- PASTE YOUR APP ID HERE
  };

  // Initialize Firebase and get Firestore instance
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<style>
  html, body {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: #f7f7f9;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    color: #111;
  }
  #header {
    width: 100%;
    text-align: center;
    padding: 20px;
    background: #0575e6;
    color: #fff;
    font-size: 28px;
    font-weight: 800;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  #leaderboardModeSelection {
    margin-top: 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
    gap: 12px;
  }
  .btnPrimary, .btnSecondary {
    padding: 10px 20px;
    border-radius: 8px;
    border: 0;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .btnPrimary {
    background: #0575e6;
    color: #fff;
    box-shadow: 0 4px 12px rgba(5,117,230,0.2);
  }
  .btnSecondary {
    background: #f0f0f0;
    color: #111;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .btnPrimary:hover {
    background: #0468d4;
  }
  .btnSecondary:hover {
    background: #e0e0e0;
  }
  #leaderboardContainer {
    width: min(720px, 95%);
    margin-top: 12px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #eee;
    background: #fff;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }
  table#leaderboardTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 18px;
  }
  thead th {
    background: #0575e6;
    color: #fff;
    padding: 15px 18px;
    font-weight: 700;
    text-align: center;
  }
  tbody td {
    padding: 15px 18px;
    border-bottom: 1px solid #f2f5ff;
    color: #111;
  }
  td.rank { width: 80px; text-align: center; font-weight: bold; }
  td.name { text-align: left; }
  td.score { text-align: right; width: 120px; font-weight: bold; }
  tbody tr:nth-child(even) { background: #fbfdff; }
  tbody tr:last-child td { border-bottom: none; }
  .topRow {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    padding: 0 12px;
    box-sizing: border-box;
    flex-wrap: wrap;
  }
  .qrCallout {
    width: 220px;
    margin-top: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid #eee;
    background: #fff;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }
  .qrCallout img {
    width: 68px;
    height: 68px;
    border-radius: 10px;
    object-fit: cover;
    border: 1px solid #f0f0f0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  .qrCopy {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .qrCopy .headline {
    font-size: 16px;
    font-weight: 800;
    color: #0d1b2a;
  }
  @media (max-width: 760px) {
    .topRow {
      gap: 10px;
    }
    .qrCallout {
      width: min(360px, 92%);
      margin-top: 0;
    }
  }
</style>
</head>
<body>
  <div id="header">Gibbon Balance Game Live Leaderboard</div>

  <div class="topRow">
    <div id="leaderboardModeSelection">
      <button id="showMovingLB" class="btnPrimary">Moving Target Leaderboard</button>
      <button id="showSurvivalLB" class="btnSecondary">Survival Arena Leaderboard</button>
    </div>

    <div class="qrCallout" aria-label="Scan the QR code to open the game">
      <img src="QR_balance_app.png" alt="QR code to open the game" />
      <div class="qrCopy">
        <div class="headline">Scan &amp; open to play</div>
      </div>
    </div>
  </div>

  <div id="leaderboardContainer">
    <table id="leaderboardTable" aria-label="Live Leaderboard">
      <thead>
        <tr><th>Rank</th><th class="name">Name</th><th class="score">Score</th></tr>
      </thead>
      <tbody id="leaderboardBody">
        <tr><td colspan="3" style="text-align:center;padding:20px;color:#666">Loading leaderboard...</td></tr>
      </tbody>
    </table>
  </div>

<script>
  // Elements
  const leaderboardBody = document.getElementById('leaderboardBody');
  const showMovingLB = document.getElementById('showMovingLB');
  const showSurvivalLB = document.getElementById('showSurvivalLB');

  // State
  let currentLeaderboardView = 2; // Default to Moving Target
  let unsubscribeLeaderboard = null; // Stores the Firestore real-time listener unsubscribe function

  // Helper for escaping HTML (for player names)
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

  // Function to render the Firebase leaderboard
  function renderFirebaseLeaderboard(level) {
    // Unsubscribe from any previously active real-time listener
    if (unsubscribeLeaderboard) {
      unsubscribeLeaderboard();
      unsubscribeLeaderboard = null;
    }

    const collectionRef = level === 2 ? db.collection('leaderboardLevel2') : db.collection('leaderboardSurvival');

    leaderboardBody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:20px;color:#666">Loading leaderboard...</td></tr>`;

    // Set up the new real-time listener
    unsubscribeLeaderboard = collectionRef
      .orderBy('score', 'desc')     // Order by score descending
      .orderBy('timestamp', 'desc') // Then by timestamp descending for ties
      .limit(500)                   // Fetch top 500 scores
      .onSnapshot(snapshot => {
        leaderboardBody.innerHTML = ''; // Clear previous entries
        if (snapshot.empty) {
          leaderboardBody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:20px;color:#666">No scores yet for this level. Play the game to add some!</td></tr>`;
          return;
        }

        // Firestore's forEach does not provide an index parameter reliably,
        // so we compute the rank manually.
        let rank = 1;
        snapshot.forEach((doc) => {
          const data = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="rank">${rank}</td><td class="name">${escapeHtml(data.playerName)}</td><td class="score">${data.score}</td>`;
          leaderboardBody.appendChild(tr);
          rank++;
        });
      }, error => {
        console.error("Error fetching leaderboard: ", error);
        leaderboardBody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:20px;color:#e60000">Error loading leaderboard.</td></tr>`;
      });
  }

  // Event Listeners for leaderboard mode selection buttons
  showMovingLB.addEventListener('click', () => {
    if (currentLeaderboardView === 2) return;
    currentLeaderboardView = 2;
    renderFirebaseLeaderboard(2);
    showMovingLB.classList.add('btnPrimary');
    showMovingLB.classList.remove('btnSecondary');
    showSurvivalLB.classList.add('btnSecondary');
    showSurvivalLB.classList.remove('btnPrimary');
  });

  showSurvivalLB.addEventListener('click', () => {
    if (currentLeaderboardView === 3) return;
    currentLeaderboardView = 3;
    renderFirebaseLeaderboard(3);
    showSurvivalLB.classList.add('btnPrimary');
    showSurvivalLB.classList.remove('btnSecondary');
    showMovingLB.classList.add('btnSecondary');
    showMovingLB.classList.remove('btnPrimary');
  });

  // Initial load: render the default leaderboard (Moving Target)
  document.addEventListener('DOMContentLoaded', () => {
    renderFirebaseLeaderboard(currentLeaderboardView);
  });
</script>
</body>
</html>
